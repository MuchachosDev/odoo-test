name: Deploy Odoo to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Setup SSH
      run: |
        # Crear directorio SSH
        mkdir -p ~/.ssh
        
        # AÃ±adir clave privada
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # Configurar SSH para no usar passphrase interactiva
        echo "Host *" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
        echo "  PasswordAuthentication no" >> ~/.ssh/config
        
    - name: ðŸš€ Deploy to server
      run: |
        ssh -o ConnectTimeout=30 -p ${{ vars.SSH_PORT || '22' }} ${{ vars.USERNAME }}@${{ vars.HOST }} << 'EOF'
          set -e
          
          echo "ðŸ”„ Iniciando deployment..."
          
          # Navegar al directorio del proyecto
          cd ${{ vars.PROJECT_PATH }}/odoo-test
          
          # Actualizar cÃ³digo
          echo "â¬‡ï¸ Actualizando cÃ³digo..."
          git fetch origin
          git reset --hard origin/${{ vars.BRANCH || 'main' }}
          
          # Dar permisos de ejecuciÃ³n al setup
          chmod +x setup.sh
          
          # Ejecutar setup.sh
          echo "ðŸ”§ Ejecutando setup.sh..."
          ./setup.sh
          
          echo "âœ… Setup completado!"
        EOF
        
    - name: ðŸ“¢ Deployment Summary
      if: always()
      run: |
        echo "## ðŸ“‹ Resumen del Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **Estado:** Exitoso" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **AcciÃ³n:** setup.sh ejecutado correctamente" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Servidor:** ${{ vars.HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Estado:** Fallido" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Revisa los logs de setup.sh para mÃ¡s detalles**" >> $GITHUB_STEP_SUMMARY
        fi
